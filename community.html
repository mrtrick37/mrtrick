<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Community — MRTrick</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="index.html">MRTrick</a>
        <nav class="nav">
          <a href="index.html">Home</a>
          <a href="docs/index.html">Guides</a>
          <a href="community.html">Community</a>
        </nav>
      </div>
    </header>

    <main class="container" style="padding:36px 0">
      <div class="community-hero">
        <h1>Community Forum</h1>
        <p class="lead">Browse topics, report compatibility notes, and start new discussions. This forum mirrors GitHub Issues for the repo.</p>
        <p>
          <a id="new-topic" class="btn primary" href="#">New Topic</a>
          <a id="refresh" class="btn ghost" href="#">Refresh</a>
        </p>
        <div id="new-topic-form" style="display:none;margin-top:18px">
          <div class="card">
            <label style="display:block;margin-bottom:8px">Title</label>
            <input id="topic-title" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" placeholder="Short descriptive title" />
            <label style="display:block;margin:10px 0 8px">Body</label>
            <textarea id="topic-body" rows="6" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" placeholder="Details, steps to reproduce, distro, GPU, driver, Proton/Wine version"></textarea>
            <div style="margin-top:10px">
              <button id="submit-topic" class="btn primary">Create Topic</button>
              <button id="cancel-topic" class="btn ghost">Cancel</button>
            </div>
            <div id="topic-feedback" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </div>
      </div>

      <section id="forum" style="margin-top:22px">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <input id="search" placeholder="Search topics or author" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" />
          <select id="per-page" style="padding:8px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.06)">
            <option value="5">5 / page</option>
            <option value="10" selected>10 / page</option>
            <option value="20">20 / page</option>
          </select>
        </div>
        <div id="topics">Loading topics…</div>
        <div id="pager" style="display:flex;gap:8px;align-items:center;margin-top:12px"></div>
      </section>
      <!-- Thread modal (hidden) -->
      <div id="thread-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);padding:30px;box-sizing:border-box;z-index:9999;">
        <div style="max-width:900px;margin:0 auto;background:var(--bg);padding:18px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6);height:calc(100% - 60px);overflow:auto;">
          <button id="close-thread" class="btn ghost" style="float:right">Close</button>
          <h2 id="thread-title"></h2>
          <p id="thread-meta" style="color:var(--muted)"></p>
          <article id="thread-body" style="margin:12px 0;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);"></article>
          <h3 style="margin-top:18px">Replies</h3>
          <div id="thread-comments" style="margin-top:8px"></div>
          <div style="margin-top:12px">
            <label style="display:block;margin-bottom:6px">Your reply</label>
            <textarea id="reply-body" rows="4" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit"></textarea>
            <div style="margin-top:8px">
              <button id="submit-reply" class="btn primary">Post Reply</button>
              <button id="cancel-reply" class="btn ghost">Cancel</button>
            </div>
            <div id="reply-feedback" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </div>
      </div>
    </main>

    <footer class="site-footer"><div class="container">&nbsp;</div></footer>

    <script>
      // Configuration: auto-detected repo owner + name
      const GITHUB_OWNER = 'mrtrick37';
      const GITHUB_REPO = 'mrtrick';
      // If you deploy the optional proxy (forum-api), set PROXY_BASE to its URL.
      // Example: const PROXY_BASE = 'https://forum.example.com';
      const PROXY_BASE = '';

      function timeAgo(iso){
        const d = new Date(iso);
        const s = Math.floor((Date.now()-d)/1000);
        if(s<60) return s+ 's';
        if(s<3600) return Math.floor(s/60)+'m';
        if(s<86400) return Math.floor(s/3600)+'h';
        return Math.floor(s/86400)+'d';
      }

      // client state for pagination/search
      let itemsCache = [];
      let filtered = [];
      let currentPage = 1;

      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]}); }

      function renderTopicsList(list){
        const container = document.getElementById('topics');
        if(!list.length){ container.innerHTML = '<p>No topics yet — be the first to create one.</p>'; return }
        const perPage = Number(document.getElementById('per-page').value||10);
        const start = (currentPage-1)*perPage;
        const pageItems = list.slice(start, start+perPage);
        const div = document.createElement('div'); div.className='grid';
        pageItems.forEach(item=>{
          const card = document.createElement('article'); card.className='card';
          const h = document.createElement('h3');
          const a = document.createElement('a'); a.href = '#'; a.rel='noopener';
          a.textContent = item.title || item.subject?.title || '';
          a.addEventListener('click',(e)=>{ e.preventDefault(); openThread(item.number, item.url); });
          h.appendChild(a);
          const meta = document.createElement('p'); meta.style.color='var(--muted)'; meta.style.margin='6px 0';
          const author = item.author?.login || item.user?.login || (item.author?.name);
          const created = item.createdAt || item.created_at;
          meta.textContent = `#${item.number || item.discussionNumber || ''} • ${author||'unknown'} • ${timeAgo(created)}`;
          const body = document.createElement('p'); body.style.opacity='0.95'; body.innerHTML = escapeHtml((item.bodyText || item.body || item.excerpt || '').slice(0,400));
          card.appendChild(h); card.appendChild(meta); card.appendChild(body);
          div.appendChild(card);
        });
        container.innerHTML=''; container.appendChild(div);

        // pager
        const pager = document.getElementById('pager');
        const totalPages = Math.max(1, Math.ceil(list.length / perPage));
        pager.innerHTML = '';
        const prev = document.createElement('button'); prev.className='btn ghost'; prev.textContent='Prev'; prev.disabled = currentPage<=1;
        const next = document.createElement('button'); next.className='btn ghost'; next.textContent='Next'; next.disabled = currentPage>=totalPages;
        const info = document.createElement('span'); info.style.color='var(--muted)'; info.textContent = ` Page ${currentPage} / ${totalPages} `;
        prev.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderTopicsList(list) }});
        next.addEventListener('click', ()=>{ if(currentPage<totalPages){ currentPage++; renderTopicsList(list) }});
        pager.appendChild(prev); pager.appendChild(info); pager.appendChild(next);
      }

      // Open a discussion thread in the in-page modal (falls back to external url)
      async function openThread(number, externalUrl){
        if(!PROXY_BASE){ window.open(externalUrl || `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/discussions/${number}`,'_blank'); return }
        const modal = document.getElementById('thread-modal');
        const titleEl = document.getElementById('thread-title');
        const metaEl = document.getElementById('thread-meta');
        const bodyEl = document.getElementById('thread-body');
        const commentsEl = document.getElementById('thread-comments');
        const feedback = document.getElementById('reply-feedback');
        titleEl.textContent = 'Loading...'; metaEl.textContent=''; bodyEl.innerHTML=''; commentsEl.innerHTML=''; feedback.textContent='';
        modal.style.display='block';
        try{
          const resp = await fetch(`${PROXY_BASE}/discussions/${number}?owner=${GITHUB_OWNER}&repo=${GITHUB_REPO}`);
          if(!resp.ok) throw new Error('Failed to load thread');
          const data = await resp.json();
          const d = data.discussion;
          titleEl.textContent = d.title || ('Discussion #'+number);
          metaEl.textContent = `by ${d.user?.login||d.author?.login||'unknown'} • ${timeAgo(d.created_at||d.createdAt)}`;
          bodyEl.innerHTML = escapeHtml(d.body || d.bodyText || '');
          // render comments
          const comments = data.comments || [];
          if(!comments.length) commentsEl.innerHTML = '<p>No replies yet.</p>';
          else{
            commentsEl.innerHTML='';
            comments.forEach(c=>{
              const wrap = document.createElement('div'); wrap.style.padding='8px'; wrap.style.borderRadius='8px'; wrap.style.marginBottom='8px'; wrap.style.background='rgba(255,255,255,0.02)';
              const meta = document.createElement('div'); meta.style.color='var(--muted)'; meta.style.marginBottom='6px'; meta.textContent = `${c.user?.login || c.author?.login || 'unknown'} • ${timeAgo(c.created_at || c.createdAt)}`;
              const b = document.createElement('div'); b.innerHTML = escapeHtml(c.body || c.bodyText || c.body_html || '');
              wrap.appendChild(meta); wrap.appendChild(b); commentsEl.appendChild(wrap);
            });
          }

          // wire reply submit
          const submit = document.getElementById('submit-reply');
          const cancel = document.getElementById('cancel-reply');
          const replyBox = document.getElementById('reply-body');
          submit.onclick = async ()=>{
            feedback.style.color='var(--muted)'; feedback.textContent='Posting…';
            const body = replyBox.value.trim();
            if(!body){ feedback.style.color='salmon'; feedback.textContent='Reply cannot be empty'; return }
            try{
              const post = await fetch(`${PROXY_BASE}/discussions/${number}/comments`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ owner: GITHUB_OWNER, repo: GITHUB_REPO, body }) });
              if(!post.ok){ const err = await post.json().catch(()=>({})); throw new Error(err.error || post.status) }
              const result = await post.json();
              feedback.style.color='var(--accent)'; feedback.textContent='Reply posted';
              replyBox.value='';
              // reload thread
              openThread(number, externalUrl);
            }catch(err){ console.error(err); feedback.style.color='salmon'; feedback.textContent='Failed to post reply'; }
          };
          cancel.onclick = ()=>{ replyBox.value=''; feedback.textContent=''; };

        }catch(err){ console.error(err); titleEl.textContent='Error loading thread'; bodyEl.innerHTML='<p>Could not load thread.</p>' }
      }

      document.getElementById('close-thread').addEventListener('click', ()=>{ document.getElementById('thread-modal').style.display='none'; document.getElementById('reply-feedback').textContent=''; document.getElementById('reply-body').value=''; });

      function applyFilter(){
        const q = (document.getElementById('search').value||'').toLowerCase().trim();
        if(!q){ filtered = itemsCache.slice(); } else {
          filtered = itemsCache.filter(it=>(((it.title||'')+' '+(it.author?.login||it.user?.login||'')+' '+(it.bodyText||'')).toLowerCase().includes(q)));
        }
        currentPage = 1; renderTopicsList(filtered);
      }

      async function loadTopics(){
        const el = document.getElementById('topics');
        el.innerHTML = 'Loading topics…';
        try{
          let items = [];
          if(PROXY_BASE){
            const resp = await fetch(`${PROXY_BASE}/discussions?owner=${GITHUB_OWNER}&repo=${GITHUB_REPO}`);
            if(!resp.ok) throw new Error('Proxy error: '+resp.status);
            const data = await resp.json();
            items = data.nodes || [];
          } else {
            // Fallback: list issues (public, rate-limited)
            const resp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/issues?state=open&per_page=200`);
            if(!resp.ok) throw new Error('GitHub API error: '+resp.status);
            items = await resp.json();
          }

          // normalize items for display
          items = items.map(it=>{
            return {
              title: it.title || it.subject?.title || '',
              url: it.html_url || it.url || it.htmlUrl || it.url,
              author: it.user ? { login: it.user.login } : (it.author || null),
              createdAt: it.created_at || it.createdAt,
              bodyText: it.body || it.bodyText || it.excerpt || '',
              number: it.number || it.discussionNumber || ''
            };
          });
          itemsCache = items.slice();
          filtered = itemsCache.slice();
          renderTopicsList(filtered);
        }catch(err){ el.innerHTML = '<p>Could not load topics — API rate limit, proxy unreachable, or network issue.</p>'; console.error(err)}
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        const newBtn = document.getElementById('new-topic');
        const formWrap = document.getElementById('new-topic-form');
        const submitBtn = document.getElementById('submit-topic');
        const cancelBtn = document.getElementById('cancel-topic');
        const feedback = document.getElementById('topic-feedback');
        const searchInput = document.getElementById('search');
        const perPageSelect = document.getElementById('per-page');

        // wire up search and per-page
        searchInput.addEventListener('input', ()=>{ currentPage=1; applyFilter(); });
        perPageSelect.addEventListener('change', ()=>{ currentPage=1; renderTopicsList(filtered); });

        newBtn.addEventListener('click', ()=>{
          // if PROXY_BASE is not configured, open GitHub new issue page
          if(!PROXY_BASE){
            const title = encodeURIComponent('[Forum] ');
            const body = encodeURIComponent('Describe your question or report here.\n\n---\n(Please include distro, GPU, driver, Proton/Wine version, and steps to reproduce)');
            const url = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/issues/new?title=${title}&body=${body}`;
            window.open(url,'_blank');
            return;
          }
          formWrap.style.display = formWrap.style.display === 'none' ? 'block' : 'none';
        });

        cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); formWrap.style.display='none'; feedback.textContent=''; });

        // confirmation modal flow: before creating, show confirm dialog
        async function createDiscussion(title, body){
          const ok = confirm('Create discussion titled:\n"'+title+'" ?');
          if(!ok) return null;
          const resp = await fetch(`${PROXY_BASE}/discussions`, {
            method:'POST', headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ owner: GITHUB_OWNER, repo: GITHUB_REPO, title, body })
          });
          if(!resp.ok){ const err = await resp.json().catch(()=>({})); throw new Error(err.error||resp.status) }
          return resp.json();
        }

        submitBtn.addEventListener('click', async (e)=>{
          e.preventDefault();
          feedback.style.color = 'var(--muted)';
          feedback.textContent = 'Submitting…';
          const title = document.getElementById('topic-title').value.trim();
          const body = document.getElementById('topic-body').value.trim();
          if(!title){ feedback.style.color='salmon'; feedback.textContent='Title is required'; return }
          try{
            const data = await createDiscussion(title, body);
            if(!data) { feedback.textContent='Cancelled'; return }
            feedback.style.color='var(--accent)';
            feedback.textContent = 'Discussion created — opening...';
            window.open(data.html_url || data.url, '_blank');
            formWrap.style.display='none';
            document.getElementById('topic-title').value='';
            document.getElementById('topic-body').value='';
            loadTopics();
          }catch(err){ console.error(err); feedback.style.color='salmon'; feedback.textContent = 'Failed to create discussion (see console)'; }
        });

        document.getElementById('refresh').addEventListener('click', (e)=>{ e.preventDefault(); loadTopics() });
        loadTopics();
      });
    </script>
  </body>
</html>
