<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Community — MRTrick</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="index.html">MRTrick</a>
        <nav class="nav">
          <a href="index.html">Home</a>
          <a href="docs/index.html">Guides</a>
          <a href="community.html">Community</a>
        </nav>
      </div>
    </header>

    <main class="container" style="padding:36px 0">
      <div class="community-hero">
        <h1>Community Forum</h1>
        <p class="lead">Browse topics, report compatibility notes, and start new discussions. This forum mirrors GitHub Issues for the repo.</p>
        <p>
          <a id="new-topic" class="btn primary" href="#">New Topic</a>
          <a id="refresh" class="btn ghost" href="#">Refresh</a>
        </p>
        <div id="new-topic-form" style="display:none;margin-top:18px">
          <div class="card">
            <label style="display:block;margin-bottom:8px">Title</label>
            <input id="topic-title" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" placeholder="Short descriptive title" />
            <label style="display:block;margin:10px 0 8px">Body</label>
            <textarea id="topic-body" rows="6" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit" placeholder="Details, steps to reproduce, distro, GPU, driver, Proton/Wine version"></textarea>
            <div style="margin-top:10px">
              <button id="submit-topic" class="btn primary">Create Topic</button>
              <button id="cancel-topic" class="btn ghost">Cancel</button>
            </div>
            <div id="topic-feedback" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </div>
      </div>

      <section id="forum" style="margin-top:22px">
        <div id="topics">Loading topics…</div>
      </section>
    </main>

    <footer class="site-footer"><div class="container">&nbsp;</div></footer>

    <script>
      // Configuration: auto-detected repo owner + name
      const GITHUB_OWNER = 'mrtrick37';
      const GITHUB_REPO = 'mrtrick';
      // If you deploy the optional proxy (forum-api), set PROXY_BASE to its URL.
      // Example: const PROXY_BASE = 'https://forum.example.com';
      const PROXY_BASE = '';

      function timeAgo(iso){
        const d = new Date(iso);
        const s = Math.floor((Date.now()-d)/1000);
        if(s<60) return s+ 's';
        if(s<3600) return Math.floor(s/60)+'m';
        if(s<86400) return Math.floor(s/3600)+'h';
        return Math.floor(s/86400)+'d';
      }

      async function loadTopics(){
        const el = document.getElementById('topics');
        el.innerHTML = 'Loading topics…';
        try{
          let items = [];
          if(PROXY_BASE){
            const resp = await fetch(`${PROXY_BASE}/discussions?owner=${GITHUB_OWNER}&repo=${GITHUB_REPO}`);
            if(!resp.ok) throw new Error('Proxy error: '+resp.status);
            const data = await resp.json();
            items = data.nodes || [];
          } else {
            // Fallback: list issues (public, rate-limited)
            const resp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/issues?state=open&per_page=30`);
            if(!resp.ok) throw new Error('GitHub API error: '+resp.status);
            items = await resp.json();
          }

          if(!items.length){ el.innerHTML = '<p>No topics yet — be the first to create one.</p>'; return }

          const list = document.createElement('div');
          list.className = 'grid';
          items.forEach(item=>{
            const card = document.createElement('article');
            card.className = 'card';
            const title = document.createElement('h3');
            const a = document.createElement('a'); a.href = item.url || item.html_url || item.htmlUrl; a.target = '_blank'; a.rel='noopener'; a.textContent = item.title || item.subject?.title || '';
            title.appendChild(a);
            const meta = document.createElement('p'); meta.style.color='var(--muted)'; meta.style.margin='6px 0';
            const author = item.author?.login || item.user?.login || (item.author?.name);
            const created = item.createdAt || item.created_at;
            meta.textContent = `#${item.number || item.discussionNumber || ''} • opened by ${author || 'unknown'} • ${timeAgo(created)} `;
            const body = document.createElement('p'); body.style.opacity='0.95'; body.textContent = (item.bodyText || item.body || item.excerpt || '').slice(0,240);
            card.appendChild(title); card.appendChild(meta); card.appendChild(body);
            list.appendChild(card);
          });
          el.innerHTML = ''; el.appendChild(list);
        }catch(err){ el.innerHTML = '<p>Could not load topics — API rate limit, proxy unreachable, or network issue.</p>'; console.error(err)}
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        const newBtn = document.getElementById('new-topic');
        const formWrap = document.getElementById('new-topic-form');
        const submitBtn = document.getElementById('submit-topic');
        const cancelBtn = document.getElementById('cancel-topic');
        const feedback = document.getElementById('topic-feedback');

        newBtn.addEventListener('click', ()=>{
          // if PROXY_BASE is not configured, open GitHub new issue page
          if(!PROXY_BASE){
            const title = encodeURIComponent('[Forum] ');
            const body = encodeURIComponent('Describe your question or report here.\n\n---\n(Please include distro, GPU, driver, Proton/Wine version, and steps to reproduce)');
            const url = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/issues/new?title=${title}&body=${body}`;
            window.open(url,'_blank');
            return;
          }
          formWrap.style.display = formWrap.style.display === 'none' ? 'block' : 'none';
        });

        cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); formWrap.style.display='none'; feedback.textContent=''; });

        submitBtn.addEventListener('click', async (e)=>{
          e.preventDefault();
          feedback.style.color = 'var(--muted)';
          feedback.textContent = 'Submitting…';
          const title = document.getElementById('topic-title').value.trim();
          const body = document.getElementById('topic-body').value.trim();
          if(!title){ feedback.style.color='salmon'; feedback.textContent='Title is required'; return }
          try{
            const resp = await fetch(`${PROXY_BASE}/discussions`, {
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ owner: GITHUB_OWNER, repo: GITHUB_REPO, title, body })
            });
            if(!resp.ok){ const err = await resp.json().catch(()=>({})); throw new Error(err.error||resp.status) }
            const data = await resp.json();
            feedback.style.color='var(--accent)';
            feedback.textContent = 'Discussion created — opening...';
            window.open(data.html_url || data.url, '_blank');
            formWrap.style.display='none';
            document.getElementById('topic-title').value='';
            document.getElementById('topic-body').value='';
            loadTopics();
          }catch(err){ console.error(err); feedback.style.color='salmon'; feedback.textContent = 'Failed to create discussion (see console)'; }
        });

        document.getElementById('refresh').addEventListener('click', (e)=>{ e.preventDefault(); loadTopics() });
        loadTopics();
      });
    </script>
  </body>
</html>
